{
  "version": 3,
  "sources": ["../../js/algorithms/fast.ts", "../../js/algorithms/index.ts", "../../js/main.ts"],
  "sourcesContent": ["type ProgressCallback = (nonce: number) => void;\n\ninterface ProcessOptions {\n  basePrefix: string;\n  version: string;\n}\n\nconst getHardwareConcurrency = () =>\n  navigator.hardwareConcurrency !== undefined ? navigator.hardwareConcurrency : 1;\n\nexport default function process(\n  options: ProcessOptions,\n  data: string,\n  difficulty: number = 5,\n  signal: AbortSignal | null = null,\n  progressCallback?: ProgressCallback,\n  threads: number = Math.trunc(Math.max(getHardwareConcurrency() / 2, 1)),\n): Promise<string> {\n  console.debug(\"fast algo\");\n\n  // Choose worker based on secure context.\n  // Use the WebCrypto worker if the page is a secure context; otherwise fall back to pure\u2011JS.\n  let workerMethod: \"webcrypto\" | \"purejs\" = \"purejs\";\n  if (window.isSecureContext) {\n    workerMethod = \"webcrypto\";\n  }\n\n  if (navigator.userAgent.includes(\"Firefox\") || navigator.userAgent.includes(\"Goanna\")) {\n    console.log(\"Firefox detected, using pure-JS fallback\");\n    workerMethod = \"purejs\";\n  }\n\n  return new Promise((resolve, reject) => {\n    let webWorkerURL = `${options.basePrefix}/.within.website/x/cmd/anubis/static/js/worker/sha256-${workerMethod}.mjs?cacheBuster=${options.version}`;\n\n    const workers: Worker[] = [];\n    let settled = false;\n\n    const onAbort = () => {\n      console.log(\"PoW aborted\");\n      cleanup();\n      reject(new DOMException(\"Aborted\", \"AbortError\"));\n    };\n\n    const cleanup = () => {\n      if (settled) {\n        return;\n      }\n      settled = true;\n      workers.forEach((w) => w.terminate());\n      if (signal != null) {\n        signal.removeEventListener(\"abort\", onAbort);\n      }\n    };\n\n    if (signal != null) {\n      if (signal.aborted) {\n        return onAbort();\n      }\n      signal.addEventListener(\"abort\", onAbort, { once: true });\n    }\n\n    for (let i = 0; i < threads; i++) {\n      let worker = new Worker(webWorkerURL);\n\n      worker.onmessage = (event) => {\n        if (typeof event.data === \"number\") {\n          progressCallback?.(event.data);\n        } else {\n          cleanup();\n          resolve(event.data);\n        }\n      };\n\n      worker.onerror = (event) => {\n        cleanup();\n        reject(event);\n      };\n\n      worker.postMessage({\n        data,\n        difficulty,\n        nonce: i,\n        threads,\n      });\n\n      workers.push(worker);\n    }\n  });\n}\n", "import fast from \"./fast\";\n\nexport default {\n  fast: fast,\n  slow: fast, // XXX(Xe): slow is deprecated, but keep this around in case anything goes bad\n}", "import algorithms from \"./algorithms\";\n\n// from Xeact\nconst u = (url: string = \"\", params: Record<string, any> = {}) => {\n  let result = new URL(url, window.location.href);\n  Object.entries(params).forEach(([k, v]) => result.searchParams.set(k, v));\n  return result.toString();\n};\n\nconst j = (id: string): any | null => {\n  const elem = document.getElementById(id);\n  if (elem === null) {\n    return null;\n  }\n\n  return JSON.parse(elem.textContent);\n};\n\nconst imageURL = (mood, cacheBuster, basePrefix) =>\n  u(`${basePrefix}/.within.website/x/cmd/anubis/static/img/${mood}.webp`, {\n    cacheBuster,\n  });\n\n// Detect available languages by loading the manifest\nconst getAvailableLanguages = async () => {\n  const basePrefix = j(\"anubis_base_prefix\");\n  if (basePrefix === null) {\n    return;\n  }\n\n  try {\n    const response = await fetch(`${basePrefix}/.within.website/x/cmd/anubis/static/locales/manifest.json`);\n    if (response.ok) {\n      const manifest = await response.json();\n      return manifest.supportedLanguages || ['en'];\n    }\n  } catch (error) {\n    console.warn('Failed to load language manifest, falling back to default languages');\n  }\n\n  // Fallback to default languages if manifest loading fails\n  return ['en'];\n};\n\n// Use the browser language from the HTML lang attribute which is set by the server settings or request headers\nconst getBrowserLanguage = async () =>\n  document.documentElement.lang;\n\n// Load translations from JSON files\nconst loadTranslations = async (lang) => {\n  const basePrefix = j(\"anubis_base_prefix\");\n  if (basePrefix === null) {\n    return;\n  }\n\n  try {\n    const response = await fetch(`${basePrefix}/.within.website/x/cmd/anubis/static/locales/${lang}.json`);\n    return await response.json();\n  } catch (error) {\n    console.warn(`Failed to load translations for ${lang}, falling back to English`);\n    if (lang !== 'en') {\n      return await loadTranslations('en');\n    }\n    throw error;\n  }\n};\n\nconst getRedirectUrl = () => {\n  const publicUrl = j(\"anubis_public_url\");\n  if (publicUrl === null) {\n    return;\n  }\n  if (publicUrl && window.location.href.startsWith(publicUrl)) {\n    const urlParams = new URLSearchParams(window.location.search);\n    return urlParams.get('redir');\n  }\n  return window.location.href;\n}\n\nlet translations = {};\nlet currentLang;\n\n// Initialize translations\nconst initTranslations = async () => {\n  currentLang = await getBrowserLanguage();\n  translations = await loadTranslations(currentLang);\n};\n\nconst t = (key) => translations[`js_${key}`] || translations[key] || key;\n\n(async () => {\n  // Initialize translations first\n  await initTranslations();\n\n  const dependencies = [\n    {\n      name: \"Web Workers\",\n      msg: t('web_workers_error'),\n      value: window.Worker,\n    },\n    {\n      name: \"Cookies\",\n      msg: t('cookies_error'),\n      value: navigator.cookieEnabled,\n    },\n  ];\n\n  const status: HTMLParagraphElement = document.getElementById(\"status\") as HTMLParagraphElement;\n  const image: HTMLImageElement = document.getElementById(\"image\") as HTMLImageElement;\n  const title: HTMLHeadingElement = document.getElementById(\"title\") as HTMLHeadingElement;\n  const progress: HTMLDivElement = document.getElementById(\"progress\") as HTMLDivElement;\n\n  const anubisVersion = j(\"anubis_version\");\n  const basePrefix = j(\"anubis_base_prefix\");\n  const details = document.querySelector(\"details\");\n  let userReadDetails = false;\n\n  if (details) {\n    details.addEventListener(\"toggle\", () => {\n      if (details.open) {\n        userReadDetails = true;\n      }\n    });\n  }\n\n  const ohNoes = ({ titleMsg, statusMsg, imageSrc }) => {\n    title.innerHTML = titleMsg;\n    status.innerHTML = statusMsg;\n    image.src = imageSrc;\n    progress.style.display = \"none\";\n  };\n\n  status.innerHTML = t('calculating');\n\n  for (const { value, name, msg } of dependencies) {\n    if (!value) {\n      ohNoes({\n        titleMsg: `${t('missing_feature')} ${name}`,\n        statusMsg: msg,\n        imageSrc: imageURL(\"reject\", anubisVersion, basePrefix),\n      });\n      return;\n    }\n  }\n\n  const { challenge, rules } = j(\"anubis_challenge\");\n\n  const process = algorithms[rules.algorithm];\n  if (!process) {\n    ohNoes({\n      titleMsg: t('challenge_error'),\n      statusMsg: t('challenge_error_msg'),\n      imageSrc: imageURL(\"reject\", anubisVersion, basePrefix),\n    });\n    return;\n  }\n\n  status.innerHTML = `${t('calculating_difficulty')} ${rules.difficulty}, `;\n  progress.style.display = \"inline-block\";\n\n  // the whole text, including \"Speed:\", as a single node, because some browsers\n  // (Firefox mobile) present screen readers with each node as a separate piece\n  // of text.\n  const rateText = document.createTextNode(`${t('speed')} 0kH/s`);\n  status.appendChild(rateText);\n\n  let lastSpeedUpdate = 0;\n  let showingApology = false;\n  const likelihood = Math.pow(16, -rules.difficulty);\n\n  try {\n    const t0 = Date.now();\n    const { hash, nonce } = await process(\n      { basePrefix, version: anubisVersion },\n      challenge.randomData,\n      rules.difficulty,\n      null,\n      (iters) => {\n        const delta = Date.now() - t0;\n        // only update the speed every second so it's less visually distracting\n        if (delta - lastSpeedUpdate > 1000) {\n          lastSpeedUpdate = delta;\n          rateText.data = `${t('speed')} ${(iters / delta).toFixed(3)}kH/s`;\n        }\n        // the probability of still being on the page is (1 - likelihood) ^ iters.\n        // by definition, half of the time the progress bar only gets to half, so\n        // apply a polynomial ease-out function to move faster in the beginning\n        // and then slow down as things get increasingly unlikely. quadratic felt\n        // the best in testing, but this may need adjustment in the future.\n\n        const probability = Math.pow(1 - likelihood, iters);\n        const distance = (1 - Math.pow(probability, 2)) * 100;\n        progress[\"aria-valuenow\"] = distance;\n        if (progress.firstElementChild !== null) {\n          (progress.firstElementChild as HTMLElement).style.width = `${distance}%`;\n        }\n\n        if (probability < 0.1 && !showingApology) {\n          status.append(\n            document.createElement(\"br\"),\n            document.createTextNode(t('verification_longer')),\n          );\n          showingApology = true;\n        }\n      },\n    );\n    const t1 = Date.now();\n    console.log({ hash, nonce });\n\n    if (userReadDetails) {\n      const container: HTMLDivElement = document.getElementById(\"progress\") as HTMLDivElement;\n\n      // Style progress bar as a continue button\n      container.style.display = \"flex\";\n      container.style.alignItems = \"center\";\n      container.style.justifyContent = \"center\";\n      container.style.height = \"2rem\";\n      container.style.borderRadius = \"1rem\";\n      container.style.cursor = \"pointer\";\n      container.style.background = \"#b16286\";\n      container.style.color = \"white\";\n      container.style.fontWeight = \"bold\";\n      container.style.outline = \"4px solid #b16286\";\n      container.style.outlineOffset = \"2px\";\n      container.style.width = \"min(20rem, 90%)\";\n      container.style.margin = \"1rem auto 2rem\";\n      container.innerHTML = t('finished_reading');\n\n      function onDetailsExpand() {\n        const redir = getRedirectUrl();\n        window.location.replace(\n          u(`${basePrefix}/.within.website/x/cmd/anubis/api/pass-challenge`, {\n            id: challenge.id,\n            response: hash,\n            nonce,\n            redir,\n            elapsedTime: t1 - t0,\n          }),\n        );\n      }\n\n      container.onclick = onDetailsExpand;\n      setTimeout(onDetailsExpand, 30000);\n    } else {\n      const redir = getRedirectUrl();\n      window.location.replace(\n        u(`${basePrefix}/.within.website/x/cmd/anubis/api/pass-challenge`, {\n          id: challenge.id,\n          response: hash,\n          nonce,\n          redir,\n          elapsedTime: t1 - t0,\n        }),\n      );\n    }\n  } catch (err) {\n    ohNoes({\n      titleMsg: t('calculation_error'),\n      statusMsg: `${t('calculation_error_msg')} ${err.message}`,\n      imageSrc: imageURL(\"reject\", anubisVersion, basePrefix),\n    });\n  }\n})();\n"],
  "mappings": "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",
  "names": ["getHardwareConcurrency", "process", "options", "data", "difficulty", "signal", "progressCallback", "threads", "workerMethod", "resolve", "reject", "webWorkerURL", "workers", "settled", "onAbort", "cleanup", "w", "i", "worker", "event", "algorithms_default", "process", "u", "url", "params", "result", "k", "v", "j", "id", "elem", "imageURL", "mood", "cacheBuster", "basePrefix", "getBrowserLanguage", "loadTranslations", "lang", "basePrefix", "j", "error", "getRedirectUrl", "publicUrl", "translations", "currentLang", "initTranslations", "t", "key", "dependencies", "status", "image", "title", "progress", "anubisVersion", "details", "userReadDetails", "ohNoes", "titleMsg", "statusMsg", "imageSrc", "value", "name", "msg", "imageURL", "challenge", "rules", "process", "algorithms_default", "rateText", "lastSpeedUpdate", "showingApology", "likelihood", "t0", "hash", "nonce", "iters", "delta", "probability", "distance", "t1", "onDetailsExpand", "redir", "u", "container", "err"]
}
