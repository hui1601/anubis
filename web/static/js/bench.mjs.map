{
  "version": 3,
  "sources": ["../../js/algorithms/fast.ts", "../../js/algorithms/index.ts", "../../js/bench.ts"],
  "sourcesContent": ["type ProgressCallback = (nonce: number) => void;\n\ninterface ProcessOptions {\n  basePrefix: string;\n  version: string;\n}\n\nconst getHardwareConcurrency = () =>\n  navigator.hardwareConcurrency !== undefined ? navigator.hardwareConcurrency : 1;\n\nexport default function process(\n  options: ProcessOptions,\n  data: string,\n  difficulty: number = 5,\n  signal: AbortSignal | null = null,\n  progressCallback?: ProgressCallback,\n  threads: number = Math.trunc(Math.max(getHardwareConcurrency() / 2, 1)),\n): Promise<string> {\n  console.debug(\"fast algo\");\n\n  // Choose worker based on secure context.\n  // Use the WebCrypto worker if the page is a secure context; otherwise fall back to pure\u2011JS.\n  let workerMethod: \"webcrypto\" | \"purejs\" = \"purejs\";\n  if (window.isSecureContext) {\n    workerMethod = \"webcrypto\";\n  }\n\n  if (navigator.userAgent.includes(\"Firefox\") || navigator.userAgent.includes(\"Goanna\")) {\n    console.log(\"Firefox detected, using pure-JS fallback\");\n    workerMethod = \"purejs\";\n  }\n\n  return new Promise((resolve, reject) => {\n    let webWorkerURL = `${options.basePrefix}/.within.website/x/cmd/anubis/static/js/worker/sha256-${workerMethod}.mjs?cacheBuster=${options.version}`;\n\n    const workers: Worker[] = [];\n    let settled = false;\n\n    const onAbort = () => {\n      console.log(\"PoW aborted\");\n      cleanup();\n      reject(new DOMException(\"Aborted\", \"AbortError\"));\n    };\n\n    const cleanup = () => {\n      if (settled) {\n        return;\n      }\n      settled = true;\n      workers.forEach((w) => w.terminate());\n      if (signal != null) {\n        signal.removeEventListener(\"abort\", onAbort);\n      }\n    };\n\n    if (signal != null) {\n      if (signal.aborted) {\n        return onAbort();\n      }\n      signal.addEventListener(\"abort\", onAbort, { once: true });\n    }\n\n    for (let i = 0; i < threads; i++) {\n      let worker = new Worker(webWorkerURL);\n\n      worker.onmessage = (event) => {\n        if (typeof event.data === \"number\") {\n          progressCallback?.(event.data);\n        } else {\n          cleanup();\n          resolve(event.data);\n        }\n      };\n\n      worker.onerror = (event) => {\n        cleanup();\n        reject(event);\n      };\n\n      worker.postMessage({\n        data,\n        difficulty,\n        nonce: i,\n        threads,\n      });\n\n      workers.push(worker);\n    }\n  });\n}\n", "import fast from \"./fast\";\n\nexport default {\n  fast: fast,\n  slow: fast, // XXX(Xe): slow is deprecated, but keep this around in case anything goes bad\n}", "import algorithms from \"./algorithms\";\n\nconst defaultDifficulty = 4;\n\nconst status: HTMLParagraphElement = document.getElementById(\"status\") as HTMLParagraphElement;\nconst difficultyInput: HTMLInputElement = document.getElementById(\"difficulty-input\") as HTMLInputElement;\nconst algorithmSelect: HTMLSelectElement = document.getElementById(\"algorithm-select\") as HTMLSelectElement;\nconst compareSelect: HTMLSelectElement = document.getElementById(\"compare-select\") as HTMLSelectElement;\nconst header: HTMLTableRowElement = document.getElementById(\"table-header\") as HTMLTableRowElement;\nconst headerCompare: HTMLTableSectionElement = document.getElementById(\"table-header-compare\") as HTMLTableSectionElement;\nconst results: HTMLTableRowElement = document.getElementById(\"results\") as HTMLTableRowElement;\n\nconst setupControls = () => {\n  if (defaultDifficulty == null) {\n    return;\n  }\n\n  difficultyInput.value = defaultDifficulty.toString();\n  for (const alg of Object.keys(algorithms)) {\n    const option1 = document.createElement(\"option\");\n    algorithmSelect?.append(option1);\n    const option2 = document.createElement(\"option\");\n    compareSelect.append(option2);\n    option1.value = option1.innerText = option2.value = option2.innerText = alg;\n  }\n};\n\nconst benchmarkTrial = async (stats, difficulty, algorithm, signal) => {\n  if (!(difficulty >= 1)) {\n    throw new Error(`Invalid difficulty: ${difficulty}`);\n  }\n  const process = algorithms[algorithm];\n  if (process == null) {\n    throw new Error(`Unknown algorithm: ${algorithm}`);\n  }\n\n  const rawChallenge = new Uint8Array(32);\n  crypto.getRandomValues(rawChallenge);\n  const challenge = Array.from(rawChallenge)\n    .map((c) => c.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n\n  const t0 = performance.now();\n  const { hash, nonce } = await process({ basePrefix: \"/\", version: \"devel\" }, challenge, Number(difficulty), signal);\n  const t1 = performance.now();\n  console.log({ hash, nonce });\n\n  stats.time += t1 - t0;\n  stats.iters += nonce;\n\n  return { time: t1 - t0, nonce };\n};\n\nconst stats = { time: 0, iters: 0 };\nconst comparison = { time: 0, iters: 0 };\nconst updateStatus = () => {\n  const mainRate = stats.iters / stats.time;\n  const compareRate = comparison.iters / comparison.time;\n  if (Number.isFinite(mainRate)) {\n    status.innerText = `Average hashrate: ${mainRate.toFixed(3)}kH/s`;\n    if (Number.isFinite(compareRate)) {\n      const change = ((mainRate - compareRate) / mainRate) * 100;\n      status.innerText += ` vs ${compareRate.toFixed(3)}kH/s (${change.toFixed(2)}% change)`;\n    }\n  } else {\n    status.innerText = \"Benchmarking...\";\n  }\n};\n\nconst tableCell = (text) => {\n  const td = document.createElement(\"td\");\n  td.innerText = text;\n  td.style.padding = \"0 0.25rem\";\n  return td;\n};\n\nconst benchmarkLoop = async (controller) => {\n  const difficulty = difficultyInput.value;\n  const algorithm = algorithmSelect.value;\n  const compareAlgorithm = compareSelect.value;\n  updateStatus();\n\n  try {\n    const { time, nonce } = await benchmarkTrial(\n      stats,\n      difficulty,\n      algorithm,\n      controller.signal,\n    );\n\n    const tr = document.createElement(\"tr\");\n    tr.style.display = \"contents\";\n    tr.append(tableCell(`${time}ms`), tableCell(nonce));\n\n    // auto-scroll to new rows\n    const atBottom =\n      results.scrollHeight - results.clientHeight <= results.scrollTop;\n    results.append(tr);\n    if (atBottom) {\n      results.scrollTop = results.scrollHeight - results.clientHeight;\n    }\n    updateStatus();\n\n    if (compareAlgorithm !== \"NONE\") {\n      const { time, nonce } = await benchmarkTrial(\n        comparison,\n        difficulty,\n        compareAlgorithm,\n        controller.signal,\n      );\n      tr.append(tableCell(`${time}ms`), tableCell(nonce));\n    }\n  } catch (e) {\n    if (e !== false) {\n      status.innerText = e;\n    }\n    return;\n  }\n\n  await benchmarkLoop(controller);\n};\n\nlet controller: AbortController | null = null;\nconst reset = () => {\n  stats.time = stats.iters = 0;\n  comparison.time = comparison.iters = 0;\n  results.innerHTML = status.innerText = \"\";\n\n  const table = results.parentElement as HTMLElement;\n  if (compareSelect.value !== \"NONE\") {\n    table.style.gridTemplateColumns = \"repeat(4,auto)\";\n    header.style.display = \"none\";\n    headerCompare.style.display = \"contents\";\n  } else {\n    table.style.gridTemplateColumns = \"repeat(2,auto)\";\n    header.style.display = \"contents\";\n    headerCompare.style.display = \"none\";\n  }\n\n  if (controller != null) {\n    controller.abort();\n  }\n  controller = new AbortController();\n  void benchmarkLoop(controller);\n};\n\nsetupControls();\ndifficultyInput.addEventListener(\"change\", reset);\nalgorithmSelect.addEventListener(\"change\", reset);\ncompareSelect.addEventListener(\"change\", reset);\nreset();\n"],
  "mappings": "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",
  "names": ["getHardwareConcurrency", "process", "options", "data", "difficulty", "signal", "progressCallback", "threads", "workerMethod", "resolve", "reject", "webWorkerURL", "workers", "settled", "onAbort", "cleanup", "w", "i", "worker", "event", "algorithms_default", "process", "defaultDifficulty", "status", "difficultyInput", "algorithmSelect", "compareSelect", "header", "headerCompare", "results", "setupControls", "alg", "algorithms_default", "option1", "option2", "benchmarkTrial", "stats", "difficulty", "algorithm", "signal", "process", "rawChallenge", "challenge", "c", "t0", "hash", "nonce", "t1", "comparison", "updateStatus", "mainRate", "compareRate", "change", "tableCell", "text", "td", "benchmarkLoop", "controller", "compareAlgorithm", "time", "tr", "atBottom", "e", "reset", "table"]
}
