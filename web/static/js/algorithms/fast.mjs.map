{
  "version": 3,
  "sources": ["../../../js/algorithms/fast.ts"],
  "sourcesContent": ["type ProgressCallback = (nonce: number) => void;\n\ninterface ProcessOptions {\n  basePrefix: string;\n  version: string;\n}\n\nconst getHardwareConcurrency = () =>\n  navigator.hardwareConcurrency !== undefined ? navigator.hardwareConcurrency : 1;\n\nexport default function process(\n  options: ProcessOptions,\n  data: string,\n  difficulty: number = 5,\n  signal: AbortSignal | null = null,\n  progressCallback?: ProgressCallback,\n  threads: number = Math.trunc(Math.max(getHardwareConcurrency() / 2, 1)),\n): Promise<string> {\n  console.debug(\"fast algo\");\n\n  // Choose worker based on secure context.\n  // Use the WebCrypto worker if the page is a secure context; otherwise fall back to pure\u2011JS.\n  let workerMethod: \"webcrypto\" | \"purejs\" = \"purejs\";\n  if (window.isSecureContext) {\n    workerMethod = \"webcrypto\";\n  }\n\n  if (navigator.userAgent.includes(\"Firefox\") || navigator.userAgent.includes(\"Goanna\")) {\n    console.log(\"Firefox detected, using pure-JS fallback\");\n    workerMethod = \"purejs\";\n  }\n\n  return new Promise((resolve, reject) => {\n    let webWorkerURL = `${options.basePrefix}/.within.website/x/cmd/anubis/static/js/worker/sha256-${workerMethod}.mjs?cacheBuster=${options.version}`;\n\n    const workers: Worker[] = [];\n    let settled = false;\n\n    const onAbort = () => {\n      console.log(\"PoW aborted\");\n      cleanup();\n      reject(new DOMException(\"Aborted\", \"AbortError\"));\n    };\n\n    const cleanup = () => {\n      if (settled) {\n        return;\n      }\n      settled = true;\n      workers.forEach((w) => w.terminate());\n      if (signal != null) {\n        signal.removeEventListener(\"abort\", onAbort);\n      }\n    };\n\n    if (signal != null) {\n      if (signal.aborted) {\n        return onAbort();\n      }\n      signal.addEventListener(\"abort\", onAbort, { once: true });\n    }\n\n    for (let i = 0; i < threads; i++) {\n      let worker = new Worker(webWorkerURL);\n\n      worker.onmessage = (event) => {\n        if (typeof event.data === \"number\") {\n          progressCallback?.(event.data);\n        } else {\n          cleanup();\n          resolve(event.data);\n        }\n      };\n\n      worker.onerror = (event) => {\n        cleanup();\n        reject(event);\n      };\n\n      worker.postMessage({\n        data,\n        difficulty,\n        nonce: i,\n        threads,\n      });\n\n      workers.push(worker);\n    }\n  });\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAOA,IAAMA,EAAyB,IAC7B,UAAU,sBAAwB,OAAY,UAAU,oBAAsB,EAEjE,SAARC,EACLC,EACAC,EACAC,EAAqB,EACrBC,EAA6B,KAC7BC,EACAC,EAAkB,KAAK,MAAM,KAAK,IAAIP,EAAuB,EAAI,EAAG,CAAC,CAAC,EACrD,CACjB,QAAQ,MAAM,WAAW,EAIzB,IAAIQ,EAAuC,SAC3C,OAAI,OAAO,kBACTA,EAAe,cAGb,UAAU,UAAU,SAAS,SAAS,GAAK,UAAU,UAAU,SAAS,QAAQ,KAClF,QAAQ,IAAI,0CAA0C,EACtDA,EAAe,UAGV,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtC,IAAIC,EAAe,GAAGT,EAAQ,UAAU,yDAAyDM,CAAY,oBAAoBN,EAAQ,OAAO,GAE1IU,EAAoB,CAAC,EACvBC,EAAU,GAERC,EAAU,IAAM,CACpB,QAAQ,IAAI,aAAa,EACzBC,EAAQ,EACRL,EAAO,IAAI,aAAa,UAAW,YAAY,CAAC,CAClD,EAEMK,EAAU,IAAM,CAChBF,IAGJA,EAAU,GACVD,EAAQ,QAASI,GAAMA,EAAE,UAAU,CAAC,EAElCX,GAAO,oBAAoB,QAASS,CAAO,EAE/C,EAEA,GAAIT,GAAU,KAAM,CAClB,GAAIA,EAAO,QACT,OAAOS,EAAQ,EAEjBT,EAAO,iBAAiB,QAASS,EAAS,CAAE,KAAM,EAAK,CAAC,CAC1D,CAEA,QAASG,EAAI,EAAGA,EAAIV,EAASU,IAAK,CAChC,IAAIC,EAAS,IAAI,OAAOP,CAAY,EAEpCO,EAAO,UAAaC,GAAU,CACxB,OAAOA,EAAM,MAAS,SACxBb,IAAmBa,EAAM,IAAI,GAE7BJ,EAAQ,EACRN,EAAQU,EAAM,IAAI,EAEtB,EAEAD,EAAO,QAAWC,GAAU,CAC1BJ,EAAQ,EACRL,EAAOS,CAAK,CACd,EAEAD,EAAO,YAAY,CACjB,KAAAf,EACA,WAAAC,EACA,MAAOa,EACP,QAAAV,CACF,CAAC,EAEDK,EAAQ,KAAKM,CAAM,CACrB,CACF,CAAC,CACH",
  "names": ["getHardwareConcurrency", "process", "options", "data", "difficulty", "signal", "progressCallback", "threads", "workerMethod", "resolve", "reject", "webWorkerURL", "workers", "settled", "onAbort", "cleanup", "w", "i", "worker", "event"]
}
